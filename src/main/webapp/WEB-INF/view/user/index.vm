<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>人员信息</title>
    #set($path = ${rc.contextPath})
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/font.css">
    <link rel="stylesheet" href="/static/css/bootstrap-datetimepicker.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/jquery.min.js" type="text/javascript"></script>
    <script src="/static/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/static/js/underscore-min.js" type="text/javascript"></script>
    <script src="/static/js/moment.min.js" type="text/javascript"></script>
    <script src="/static/js/common.js" type="text/javascript"></script>
    <script src="/static/js/alert.js" type="text/javascript"></script>
    <script src="/static/js/index.js" type="text/javascript"></script>
    <!-- jqgrid -->
    <script src="$path/static/js/jqgrid/grid.locale-cn.js" type="text/javascript"></script>
    <script src="$path/static/js/jqgrid/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="$path/static/js/jqgrid/table-jqgrid.js" type="text/javascript"></script>
    <!-- json-serializeObject -->
    <script src="$path/static/js/json/json-serializeObject.js" type="text/javascript"></script>
    <script src="/static/js/bootstrap-datetimepicker.js" type="text/javascript"></script>
</head>
<body>
<!-- 右侧内容 start -->
<form id="userForm">
<div class="content-header">
    <div class="float-left">
        <a class="btnDefault bgGreen" href="#addUser" data-toggle="modal" data-target="#addUser">新增人员</a>
        <a class="btnDefault" href="#export" data-toggle="modal" data-target="#export">导入</a>
    </div>
    <div class=" float-right">
        <div class="search-input">
            <span class="icon-5"></span>
            <input type="text" placeholder="姓名/员工编号/岗位">
        </div>
        <a class="btnDefault bgBlue" href="javascript:;">查询</a>
    </div>
</div>
<!-- 右侧内容 end -->
<!-- 表格 start -->
<div class="wrapper">
    <table class="table">
        <thead>
            <tr>
                <th>员工编号</th>
                <th>姓名</th>
                <th>岗位</th>
                <th>站区</th>
                <th>站点</th>
                <th>权限</th>
                <th>密码</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>12112121</td>
                <td>高阳</td>
                <td>站区长</td>
                <td>西直门战区</td>
                <td>西直门</td>
                <td>管理员</td>
                <td>200</td>
                <td>
                    <a href="#editUser" data-toggle="modal" data-target="#editUser">编辑</a>
                    <a class="delete" href="javascript:;">删除</a>
                </td>
            </tr>
            <tr>
                <td>12112121</td>
                <td>叶涛涛</td>
                <td>站区助理</td>
                <td>西直门战区</td>
                <td>车公庄</td>
                <td>管理员</td>
                <td>200</td>
                <td>
                    <a href="#editUser" data-toggle="modal" data-target="#editUser">编辑</a>
                    <a class="delete" href="javascript:;">删除</a>
                </td>
            </tr>
            <tr>
                <td>12112121</td>
                <td>陈云</td>
                <td>值班站长</td>
                <td>西直门战区</td>
                <td>公务员</td>
                <td>无</td>
                <td>200</td>
                <td>
                    <a href="#editUser" data-toggle="modal" data-target="#editUser">编辑</a>
                    <a class="delete" href="javascript:;">删除</a>
                </td>
            </tr>
            <tr>
                <td>12112121</td>
                <td>李双喜</td>
                <td>站务员</td>
                <td>西直门战区</td>
                <td>新街口</td>
                <td>无</td>
                <td>200</td>
                <td>
                    <a href="#editUser" data-toggle="modal" data-target="#editUser">编辑</a>
                    <a class="delete" href="javascript:;">删除</a>
                </td>
            </tr>
        </tbody>
    </table>
    <div id="page" class="page">
        <ul>
            <li class="icon-20"></li>
            <li class="active">1</li>
            <li>2</li>
            <li>3</li>
            <li>4</li>
            <li>...</li>
            <li>26</li>
            <li class="icon-22"></li>
        </ul>
    </div>
</div>
<!-- 表格 end -->
</form>
<!-- 新增人员 -->

<div class="modal" id="addUser" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <a href="javascript:;" class="close icon-1" data-dismiss="modal" aria-label="Close"></a>
                <h4 class="modal-title">新增人员</h4>
            </div>
            <div class="modal-body">
                <form id="userAddForm" class="form-container clear">
                    <div class="form_line">
                        <label class="require">员工编号</label>
                        <input id="userCode" name="userCode" type="text">
                    </div>
                    <div class="form_line">
                        <label class="require">姓名</label>
                        <input id="userName" name="userName" type="text">
                    </div>
                    <div class="form_line">
                        <label class="require">站区</label>
                        <select id="stationArea" name="stationArea">
                            <option>西直门站区</option>
                            <option>永泰庄站区</option>
                        </select>
                    </div>
                    <div class="form_line">
                        <label class="require">站点</label>
                        <select id="station" name="station">
                            <option>西直门</option>
                            <option>动物园</option>
                        </select>
                    </div>
                    <div class="form_line">
                        <label class="require">岗位</label>
                        <select id="position" name="position">
                            <option>站区长</option>
                            <option>站区助理</option>
                            <option>值班站长</option>
                            <option>站务员</option>
                        </select>
                    </div>
                    <div class="form_line">
                        <label>管理员</label>
                        <select id="isAdmin" name="isAdmin">
                            <option value="1">是</option>
                            <option value="0">否</option>
                        </select>
                    </div>
                    <div class="form_line hidden">
                        <label class="red">密码</label>
                        <span>123456</span>
                        <span class="orange">请记录此密码作为下次登录用</span>
                    </div>
                    <div class="form_line hidden">
                        <label>权限方案</label>
                        <select>
                            <option></option>
                            <option></option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <a class="btn btn-confirm" href="javascript:;" onclick="userAdd()">确定</a>
                <button class="btn btn-cancel" href="javascript:;" data-dismiss="modal" aria-label="Close">取消</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="editUser" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <a href="javascript:;" class="close icon-1" data-dismiss="modal" aria-label="Close"></a>
                <h4 class="modal-title">编辑人员</h4>
            </div>
            <div class="modal-body">
                <form class="form-container clear">
                    <div class="form_line">
                        <label class="require">员工编号</label>
                        <span>21212121</span>
                    </div>
                    <div class="form_line">
                        <label class="require">姓名</label>
                        <span>侯玉洁</span>
                    </div>
                    <div class="form_line">
                        <label class="require">站区</label>
                        <select>
                            <option>西直门站区</option>
                            <option selected>永泰庄站区</option>
                        </select>
                    </div>
                    <div class="form_line">
                        <label class="require">站点</label>
                        <select>
                            <option>西直门</option>
                            <option selected>动物园</option>
                        </select>
                    </div>
                    <div class="form_line">
                        <label class="require">岗位</label>
                        <select>
                            <option>站区长</option>
                            <option>站区助理</option>
                            <option>值班站长</option>
                            <option selected>站务员</option>
                        </select>
                    </div>
                    <div class="form_line psw">
                        <label class="red">密码</label>
                        <input type="text" value="123456">
                        <a class="btn btn-confirm" href="javascript:;">更换密码</a>
                        <p class="orange">请记录此密码作为下次登录使用</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <a class="btn btn-confirm" href="javascript:;">确定</a>
                <button class="btn btn-cancel" href="javascript:;" data-dismiss="modal" aria-label="Close">取消</button>
            </div>
        </div>
    </div>
</div>
<!-- 导入 -->
<div class="modal" id="export" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog " role="document">
        <div class="modal-content">
            <div class="modal-header">
                <a href="javascript:;" class="close icon-1" data-dismiss="modal" aria-label="Close"></a>
                <h4 class="modal-title">导入人员</h4>
            </div>
            <div class="modal-body">
                <form class="form-container clear">
                    <div class="form_line">
                        <p>请选择需要导入的Excel文件(xls,xlsx)  </p>
                        <input type="text">
                        <a class="btn btn-confirm" href="javascript:;">浏览</a>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <a class="btn btn-confirm" href="javascript:;">确定</a>
                <button class="btn btn-cancel" href="javascript:;" data-dismiss="modal" aria-label="Close">取消</button>
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        tableInit();


    function tableInit(){
        $("#userTable").jqGrid({
            url:"$path/users",
            datatype:"json",
            mtype:"get",
            height:'auto',
            autowidth:true,
            postData: {
                search : JSON.stringify($('#userForm').serializeObject())
            },
            colNames:['账号', '工号', '姓名','联系电话','所属部门',"拥有角色","","操作"],
            colModel:[
                {name:'userName', width:'15%'},
                {name:'userCode', width:'15%'},
                {name:'stationArea', width:'15%'},
                {name:'station', width:'15%'},
                {name:'roleNames', width:'10%'},
                {name:'isDeleted', width:'10%',hidden:true},
                {name:'operation', width:'10%',formatter:function(cellvalue,options,rowObject){
                    //var str = '<a href="" target="myiframe">登录日志</a><span class="separate"> | </span>';
                    var	str='';
                    if($shiro.hasPermission("人员管理-编辑")){
                        str = '<a href="javascript:;"' + (rowObject.isDeleted == 0 ? 'onclick="editUser('+ rowObject.userId +')" class="edit"' : 'class="edit disabled"') +'>编辑</a>';
                    }
                    str += '<span class="separate"> | </span>';
                    if($shiro.hasPermission("人员管理-停用")){
                        str += '<a class="stop" href="javascript:;" onclick="userStatus('+ rowObject.userId+')">删除</a>';
                }
                return str;
    }},
    ],
    viewrecords: true,//是否在浏览导航栏显示记录总数
            rowNum:10,//每页显示记录数
            pager:$('#page'),
            jsonReader:{
        page: "page",
                total: "pages",
                records: "count",
                root: "results",
                repeatitems: false,
                id: "userId"
    },
    gridComplete:function(){
        resize();
        $("#userTable tr td[aria-describedby $= 'isDeleted']").each(function(){
            var isDeleted = $(this).text();
            isDeleted == 1 ? $(this).parent().addClass("disabled") : $(this).parent().removeClass("disabled");
        })
    }
    });
    }

    function getTableData() {
        $("#userTable").jqGrid('setGridParam',{
            postData: {
                search : JSON.stringify($('#userForm').serializeObject())
            }
        }).trigger('reloadGrid');
    }

    function addRole(){
        var checkboxOne =$("#roleSelect").find(":checkbox:checked");
        var arrOne = [];
        for(var i=0;i<checkboxOne.length;i++){
            var obj=checkboxOne[i];
            if(obj.checked==true){
                arrOne.push($(checkboxOne[i]).attr("value"));
            }
        }
        $("#roleIds").val(arrOne);
        userAdd();
    }

    function userAdd(){
        var result = formValidation($("#userAddForm"));
        if(!result){
            return false;
        }
        jQuery.ajax({
            async: false,
            type: "post",
            url: "$path/permissions/addUser",
            data: $('#userAddForm').serialize(),
            dataType: "json",
            error: function (request) {
                initAlert(0,"网络错误");
            },
            success: function (data) {
                for(x in data){
                    initAlert(x,data[x]);
                }
                setTimeout(function(){
                    $("#people-add").hide();
                    $("#mask",parent.document).hide();
                },2000)
                $(".ui-jqgrid-btable").jqGrid().trigger('reloadGrid');
            }
        });
    }

    function editUser(userId){
        jQuery.ajax({
            type: "get",
            url: "$path/users/" + userId,
            data: null,
            dataType: "json",
            error: function (xmlHttpReq, status) {
                initAlert(0,"网络错误");
            },
            success: function (data) {
                $("#editUserId").val(data.userId);
                $("#editLoginName").val(data.loginName);
                $("#editEmployeeCode").val(data.employeeCode);
                $("#editName").val(data.name);
                $("#editStation").val(data.station);
                $("#editPhone").val(data.phone);
                $("#editStationArea").empty();
                if(data.stationArea=="男") {
                    option = "<option selected>男</option>";
                }else{
                    option = "<option>男</option>";
                }
                $("#editStationArea").append(option);
                if(data.stationArea=="女") {
                    option = "<option selected>女</option>";
                }else{
                    option = "<option>女</option>";
                }
                $("#editStationArea").append(option);
                $("#editDept").val(data.departmentId);
                console.log(data.roles);
                $(".select-drop li").remove();
                $(".editRole input[type='checkbox']").prop("checked",false);
                for(var i=0;i<data.roles.length;i++){
                    $(".editRole [value='"+data.roles[i].roleId+"']").click();
                }
                $("#people-edit").show();
            }
        });
    }

    function editRole(){
        var checkboxOne =$("#editRoleSelect").find(":checkbox:checked");
        var arrOne = [];
        for(var i=0;i<checkboxOne.length;i++){
            var obj=checkboxOne[i];
            if(obj.checked==true){
                arrOne.push($(checkboxOne[i]).attr("value"));
            }
        }
        $("#editRoleIds").val(arrOne);
        userUpdate();
    }

    function userUpdate(){
        var result = formValidation($("#userEditForm"));
        if(!result){
            return false;
        }
        jQuery.ajax({
            async: false,
            type: "put",
            url: "$path/users?" + $('#userEditForm').serialize(),
            data: null,
            dataType: "json",
            error: function () {
                initAlert(0,"网络错误");
            },
            success: function (result) {
                initAlert(result.data, result.message);
                $(".ui-jqgrid-btable").jqGrid().trigger('reloadGrid');
            }
        });
    }

    function userStatus(userId, isDeleted){
        jQuery.ajax({
            async: false,
            type: "post",
            url: "$path/users/" + userId + "/updateStatus",
            data: {_method:"put",isDeleted:isDeleted},
            dataType: "json",
            error: function () {
                initAlert(0,"网络错误");
            },
            success: function (data) {
                var tdisDeleted = $("#"+userId).find("[aria-describedby $= 'isDeleted']");
                var edit = $("#"+userId).find(".edit");
                var stop = $("#"+userId).find(".stop");
                if(tdisDeleted.text() == '0'){
                    $("#"+userId).addClass("disabled");
                    stop.attr("onclick","userStatus("+ userId +","+ 1 +")").text("启用");
                    edit.attr("onclick","").addClass("disabled");
                }else{
                    $("#"+userId).removeClass("disabled");
                    stop.attr("onclick","userStatus("+ userId +","+ 0 +")").text("停用");
                    edit.attr("onclick","editUser("+ userId +")").removeClass("disabled");
                }
                tdisDeleted.text(isDeleted);
                getTableData();
            }
        });
    }

    function resetPass(){
        var userId = $("#editUserId").val();
        jQuery.ajax({
            async: false,
            type: "put",
            url: "$path/users/" + userId + "/resetPass",
            data: null,
            dataType: "json",
            error: function () {
                initAlert(0, "网络错误");
            },
            success: function (result) {
                initAlert(result.data, result.message);
            }
        });
    }
    });
</script>
</body>
</html>