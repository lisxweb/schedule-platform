<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"      
 "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.ducetech.app.dao.UserDAO">
	<resultMap type="com.ducetech.app.model.User" id="userMap">
		<id column="user_id" property="userId"/>
    	<result column="password" property="password"/>
    	<result column="secret_key" property="secretKey"/>
    	<result column="user_code" property="userCode"/>
        <result column="user_job" property="userJob"/>
        <result column="user_name" property="userName"/>
    	<result column="station_area" property="stationArea"/>
    	<result column="station" property="station"/>
    	<result column="creator_id" property="creatorId"/>
    	<result column="created_at" property="createdAt"/>
    	<result column="is_deleted" property="isDeleted"/>
        <result column="is_admin" property="isAdmin"/>
	</resultMap>
	
	<!-- 登录 -->
	<select id="selectUserByUserName" resultMap="userMap">
		select user_id, password, secret_key, user_code,user_job, user_name, station_area, station, creator_id, created_at, is_deleted from user where user_name=#{userName}
	</select>
    <select id="selectUserByUserCode" resultMap="userMap">
        select user_id, password, secret_key, user_code,user_job, user_name, station_area, station, creator_id, created_at, is_deleted from user where user_code=#{userCode}
    </select>
	
	<!-- 获取某用户的全部菜单权限 -->
	<select id="selectPermissionByUserId" resultType="String">
		select permission_str from permission where permission.permission_id in(select 
		role_permission.permission_id from role_permission where role_permission.role_id 
		in (select user_role.role_id from user_role where user_role.user_id=#{userId}))
	</select>
	
	<!-- 根据ID精确查找用户 -->
	<select id="selectUserByUserId" resultMap="userMap">
		select user_id, login_name, password, secret_key, employee_code, name, gender, department_id, phone, email, creator_id, created_at, is_deleted from user where user_id=#{userId}
	</select>
	
	<!-- 对用户的通用查询  -->
	<select id="selectUser" parameterType="com.ducetech.app.model.User" resultMap="userMap">
		select user_id, login_name, password, secret_key, employee_code, name, gender, department_id, phone, email, creator_id, created_at, is_deleted from user where 1=1
		<if test="userCode!=null and userCode!=''">
			and user_code=#{userCode}
		</if>
		<if test="userName!=null and userName!=''">
			and user_name like '%' #{userName} '%'
		</if>
		<if test="stationArea!=null and stationArea!=''">
			and station_area=#{stationArea}
		</if>
		<if test="station!=null and station!=''">
			and station=#{station}
		</if>
		<if test="userJob!=null and userJob!=''">
			and user_job=#{userJob}
		</if>
		<if test="isAdmin!=null and isAdmin!=''">
			and is_admin=#{isAdmin}
		</if>
		<if test="creatorId!=null and creatorId!=''">
			and creator_id=#{creatorId}
		</if>
		<if test="createdAt!=null and createdAt!=''">
			and created_at=#{createdAt}
		</if>
		<if test="isDeleted!=null and isDeleted!=''">
			and is_deleted=#{isDeleted}
		</if>
	</select>
	
	<!-- 插入新用户 -->
	<insert id="insertUser" useGeneratedKeys="true" keyProperty="userId">
		insert into user (login_name,password,secret_key,employee_code,name,email,gender,phone,department_id,create_by_id,create_at)
		values(#{loginName},#{password},#{secretKey},#{userCode},#{name},#{email},#{gender},#{phone},#{departmentId},#{createById},#{createAt})
	</insert>
	
	<!-- 更新某用户信息 -->
	<update id="updateUser" parameterType="com.ducetech.app.model.User">
		update user 
		<set>
			<if test="loginName != null and loginName != ''">
				login_name=#{loginName},
			</if>
			<if test="password != null and password != ''">
				password=#{password},
			</if>
			<if test="userCode != null and userCode != ''">
				employee_code=#{userCode},
			</if>
			<if test="name != null and name != ''">
				name=#{name},
			</if>
			<if test="gender != null and gender != ''">
				gender=#{gender},
			</if>
			<if test="email != null and email != ''">
				email=#{email},
			</if>
			<if test="phone != null and phone != ''">
				phone=#{phone},
			</if>
			<if test="departmentId != null and departmentId != ''">
				department_id=#{departmentId},
			</if>
			<if test="creatorId!=null and creatorId!=''">
				creator_id=#{creatorId},
			</if>
			<if test="createdAt!=null and createdAt!=''">
				created_at=#{createdAt},
			</if>
			<if test="isDeleted!=null and isDeleted!=''">
				is_deleted=#{isDeleted}
			</if>
		</set>
		where user_id=#{userId}
	</update>
	
	<!-- 通过角色ID获取人员  -->
	<select id="selectUsersByRoleId" resultMap="userMap">
		select user_id, login_name, password, secret_key, employee_code, name, gender, department_id, phone, email, creator_id, created_at, is_deleted from user where user_id in (select user_id from user_role where role_id=#{roleId})
	</select>
</mapper>